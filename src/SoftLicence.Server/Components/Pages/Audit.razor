@page "/audit"
@inject LicenseDbContext Db
@inject SoftLicence.Server.Services.TimeZoneService TZ
@inject SoftLicence.Server.Services.GeoIpService GeoIp
@inject SoftLicence.Server.Services.ToastService Toast
@inject SoftLicence.Server.Services.AuditNotifier AuditNotifier
@implements IDisposable
@using SoftLicence.Server.Data
@using Microsoft.EntityFrameworkCore
@using SoftLicence.Server.Models

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Journal d'audit global</h3>
    <div class="d-flex gap-2">
        <div class="btn-group btn-group-sm me-2">
            <button class="btn @(!HideScans ? "btn-warning" : "btn-outline-warning")" @onclick="ToggleScans" title="Afficher les tentatives de scan des bots (404)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-robot me-1" viewBox="0 0 16 16"><path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a4.417 4.417 0 0 1-1.528 3.33L11.414 13H4.586l-.058-.05a4.423 4.423 0 0 1-1.528-3.33V8.062ZM5.53 4.886c-1.711-.158-3.53 1.13-3.53 3.176v1.157a5.423 4.423 0 0 0 1.874 4.08l.458.39a.5.5 0 0 0 .332.17h6.612a.5.5 0 0 0 .332-.17l.458-.39A5.423 5.423 0 0 0 14 9.219V8.062c0-2.046-1.819-3.334-3.53-3.176a25.578 25.578 0 0 1-4.94 0Z"/><path d="M14 7V5.672a.5.5 0 0 0-.146-.354l-1.328-1.328a.5.5 0 0 0-.354-.146H3.828a.5.5 0 0 0-.354.146L2.146 5.318a.5.5 0 0 0-.146.354V7a.5.5 0 0 1-1 0V5.672a1.5 1.5 0 0 1 .44-1.06l1.328-1.328A1.5 1.5 0 0 1 3.828 2.83h8.344a1.5 1.5 0 0 1 1.06.44l1.328 1.328a1.5 1.5 0 0 1 .44 1.06V7a.5.5 0 0 1-1 0Z"/><path d="M9.5 8.5a.5.5 0 1 1 1 0 .5.5 0 0 1-1 0Zm-4 0a.5.5 0 1 1 1 0 .5.5 0 0 1-1 0Z"/></svg>
                @(HideScans ? "Scans masqués" : "Scans visibles")
            </button>
        </div>
        <select class="form-select form-select-sm" style="width: 100px;" @bind:get="FilterMethod" @bind:set="async (v) => { FilterMethod = v; await Refresh(); }">
            <option value="">Méthode</option>
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
        </select>
        <select class="form-select form-select-sm" style="width: 120px;" @bind:get="FilterStatus" @bind:set="async (v) => { FilterStatus = v; await Refresh(); }">
            <option value="">Statut</option>
            <option value="200">200 OK</option>
            <option value="400">400 Bad Request</option>
            <option value="401">401 Unauthorized</option>
            <option value="403">403 Forbidden</option>
            <option value="404">404 Not Found</option>
            <option value="500">500 Error</option>
        </select>
        <input class="form-control form-control-sm" style="width: 200px;" placeholder="Rechercher..." @bind="SearchTerm" @bind:event="oninput" />
        <button class="btn btn-primary btn-sm" @onclick="Refresh">Actualiser</button>
    </div>
</div>

<div class="row g-4">
    <div class="col-12">
        <div class="table-responsive shadow-sm">
            <table class="table table-hover table-sm align-middle" style="font-size: 0.85rem;">
                <thead>
                    <tr>
                        <th>Date (Locale)</th>
                        <th>Méthode</th>
                        <th>Path</th>
                        <th class="text-center">Score</th>
                        <th>Statut</th>
                        <th>Pays</th>
                        <th>IP / ISP</th>
                        <th>App / détails</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Logs != null)
                    {
                        @foreach (var log in Logs)
                        {
                            <tr class="@GetRowClass(log)">
                                <td class="text-nowrap">@TZ.ToLocal(log.Timestamp).ToString("HH:mm:ss") <small class="text-muted">@TZ.ToLocal(log.Timestamp).ToString("dd/MM")</small></td>
                                <td><span class="badge bg-secondary">@log.Method</span></td>
                                <td class="text-truncate" style="max-width: 250px;" title="@log.Path">@log.Path</td>
                                <td class="text-center">
                                    @if (log.ThreatScore > 0)
                                    {
                                        var badgeClass = log.ThreatScore >= 100 ? "bg-danger" : log.ThreatScore >= 50 ? "bg-warning text-dark" : "bg-info text-dark";
                                        <span class="badge @badgeClass" style="font-size: 0.7rem; min-width: 35px;">@log.ThreatScore</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">0</span>
                                    }
                                </td>
                                <td class="text-nowrap">
                                    <span class="badge @GetStatusBadgeClass(log.StatusCode)">
                                        @log.StatusCode - @log.ResultStatus
                                    </span>
                                    @if (!string.IsNullOrEmpty(log.ErrorDetails))
                                    {
                                        <span class="ms-1 text-danger cursor-pointer" title="Cliquez pour voir les détails" @onclick="() => SelectedLog = log">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>
                                        </span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(log.CountryCode) && log.CountryCode != "--")
                                    {
                                        <img src="https://flagcdn.com/16x12/@(log.CountryCode.ToLower()).png" width="16" height="12" class="me-1" title="@log.CountryCode" />
                                        <span>@log.CountryCode</span>
                                    }
                                    else { <span class="text-muted">--</span> }
                                </td>
                                <td class="text-nowrap" title="IP Complète : @log.ClientIp | ISP : @(string.IsNullOrEmpty(log.Isp) ? "Inconnu" : log.Isp)">
                                    <code>@AnonymizeIp(log.ClientIp)</code>
                                    @if (log.IsProxy)
                                    {
                                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6rem;">VPN/BOT</span>
                                    }
                                    @if (!string.IsNullOrEmpty(log.Isp) && log.Isp != "Unknown")
                                    {
                                        <div class="text-muted" style="font-size: 0.65rem; max-width: 120px; overflow: hidden; text-overflow: ellipsis;">@log.Isp</div>
                                    }
                                </td>
                                <td class="text-nowrap">
                                    @if (log.AppName == "BOT_SCAN")
                                    {
                                        <span class="fw-bold text-warning">@log.AppName</span>
                                    }
                                    else if (!string.IsNullOrEmpty(log.AppName))
                                    {
                                        <span class="fw-bold">@log.AppName</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">Web Interface</span>
                                    }
                                    <span class="text-secondary ms-1 small">(@log.Endpoint)</span>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        @if (TotalCount > 0)
        {
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">Afficher</small>
                    <select class="form-select form-select-sm" style="width: 80px;" @bind:get="PageSize" @bind:set="ChangePageSize">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <small class="text-muted">sur @TotalCount entrées</small>
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => GoToPage(CurrentPage - 1)">Précédent</button>
                        </li>
                        <li class="page-item disabled"><span class="page-link">Page @CurrentPage / @TotalPages</span></li>
                        <li class="page-item @(CurrentPage >= TotalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => GoToPage(CurrentPage + 1)">Suivant</button>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    </div>

    <!-- IPS BANNIES (En dessous) -->
    <div class="col-12 mt-4">
        <div class="card h-100 shadow-sm border-warning bg-dark bg-opacity-10">
            <div class="card-header bg-warning bg-opacity-10 py-3 border-warning border-opacity-25">
                <h6 class="text-warning d-flex align-items-center mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-shield-slash me-2" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.093 3.093c-.465.42-.797.927-.988 1.485 1.22 3.118 3.455 6.488 6.46 9.46a18.6 18.6 0 0 0 1.435 1.417 36 36 0 0 0 1.435-1.417c3.005-2.972 5.24-6.342 6.46-9.461a6.4 6.4 0 0 0-.988-1.484L1.093 3.093Zm2.818-1.99a7.4 7.4 0 0 1 8.178 0l.03.022a1.5 1.5 0 0 1 .146 1.263c-.596 4.477.787 7.795 2.465 9.99a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.2 7.2 0 0 0 1.048-.625 11.8 11.8 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.5 1.5 0 0 1 .146-1.263l.03-.022ZM8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.2 7.2 0 0 0 1.048-.625 11.8 11.8 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.5 1.5 0 0 1 .146-1.263l.03-.022ZM8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.2 7.2 0 0 0 1.048-.625 11.8 11.8 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.5 1.5 0 0 1 .146-1.263l.03-.022ZM8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.2 7.2 0 0 0 1.048-.625 11.8 11.8 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.5 1.5 0 0 1 .146-1.263l.03-.022ZM8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.2 7.2 0 0 0 1.048-.625 11.8 11.8 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.5 1.5 0 0 1 .146-1.263l.03-.022ZM8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.2 7.2 0 0 0 1.048-.625 11.8 11.8 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.5 1.5 0 0 1 .146-1.263l.03-.022ZM8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.2 7.2 0 0 0 1.048-.625 11.8 11.8 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.5 1.5 0 0 1 .146-1.263l.03-.022ZM8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.2 7.2 0 0 0 1.048-.625 11.8 11.8 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.5 1.5 0 0 1 .146-1.263l.03-.022ZM8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.2 7.2 0 0 0 1.048-.625 11.8 11.8 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.5 1.5 0 0 1 .146-1.263l.03-.022Z"/></svg>
                    Bannissements actifs (24h)
                </h6>
            </div>
            <div class="card-body">
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-3">
                    @foreach (var ban in BannedIps)
                    {
                        var geo = ResolvedBans.GetValueOrDefault(ban.IpAddress, new GeoInfo());
                        <div class="col">
                            <div class="p-3 bg-black rounded border border-secondary border-opacity-50 shadow-sm h-100 animate-fade d-flex flex-column justify-content-between">
                                <div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="d-flex align-items-center">
                                            @if (!string.IsNullOrEmpty(geo.CountryCode) && geo.CountryCode != "--")
                                            {
                                                <img src="https://flagcdn.com/16x12/@(geo.CountryCode.ToLower()).png" width="16" height="12" class="me-2" />
                                            }
                                            <code class="text-info small">@AnonymizeIp(ban.IpAddress)</code>
                                        </div>
                                        <button class="btn btn-sm btn-link text-success p-0" title="Débannir (Pardonner)" @onclick="() => Unban(ban.IpAddress)">
                                            ✓
                                        </button>
                                    </div>
                                    <div class="text-muted small text-truncate" title="@geo.Isp">
                                        <strong>ISP:</strong> @geo.Isp
                                    </div>
                                    <div class="text-warning mt-2" style="font-size: 0.75rem;">
                                        ⚠ @ban.Reason
                                    </div>
                                </div>
                                <div class="text-end mt-3 border-top border-secondary border-opacity-25 pt-2">
                                    <small class="text-muted" style="font-size: 0.65rem;">Expire le @(ban.ExpiresAt.HasValue ? TZ.ToLocal(ban.ExpiresAt.Value).ToString("dd/MM à HH:mm") : "Jamais")</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                @if (!BannedIps.Any())
                {
                    <div class="text-center py-5 text-muted small italic">Aucun bannissement actif détecté sur les dernières 24 heures.</div>
                }
            </div>
        </div>
    </div>
</div>

@if (SelectedLog != null)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.7);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Détails de l'erreur</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => SelectedLog = null"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 d-flex gap-4">
                        <div>
                            <small class="text-muted d-block">User-Agent :</small>
                            <code class="small" style="word-break: break-all;">@SelectedLog.UserAgent</code>
                        </div>
                        @if (!string.IsNullOrEmpty(SelectedLog.Isp))
                        {
                            <div style="min-width: 150px;">
                                <small class="text-muted d-block">Fournisseur (ISP) :</small>
                                <span class="small text-info">@SelectedLog.Isp</span>
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(SelectedLog.RequestBody))
                    {
                        <p class="small text-muted mb-2">Données reçues (Request Body) :</p>
                        <textarea class="form-control bg-black text-info font-monospace mb-3" rows="6" readonly>@SelectedLog.RequestBody</textarea>
                    }

                    <p class="small text-muted mb-2">Message renvoyé par le serveur :</p>
                    <textarea class="form-control bg-black text-danger font-monospace" rows="6" readonly>@SelectedLog.ErrorDetails</textarea>
                    <div class="mt-2 text-end">
                        <small class="text-muted italic">Vous pouvez sélectionner et copier le texte ci-dessus.</small>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" @onclick="() => SelectedLog = null">Fermer</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .bg-black { background-color: #000 !important; }
    .animate-fade { animation: fadeIn 0.3s ease-out; }
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .cursor-pointer { cursor: pointer; }
    .table-info-soft { background-color: rgba(13, 110, 253, 0.05) !important; }
    .table-auth-soft { background-color: rgba(111, 66, 193, 0.1) !important; }
    .table-warning-soft { background-color: rgba(255, 193, 7, 0.05) !important; }
    .table-danger-hard { background-color: rgba(220, 53, 69, 0.15) !important; }
</style>

@code {
    private List<AccessLog> Logs = new();
    private List<BannedIp> BannedIps = new();
    private Dictionary<string, GeoInfo> ResolvedBans = new();
    
    private AccessLog? SelectedLog;
    private string SearchTerm = "";
    private string FilterMethod = "";
    private string FilterStatus = "";
    private bool HideScans = true;

    // Pagination
    private int CurrentPage = 1;
    private int PageSize = 25;
    private int TotalCount = 0;
    private int TotalPages => (int)Math.Ceiling((double)TotalCount / PageSize);

    protected override async Task OnInitializedAsync()
    {
        AuditNotifier.OnNewLog += OnNewLogReceived;
        await Refresh();
    }

    private async void OnNewLogReceived()
    {
        await InvokeAsync(async () =>
        {
            await Refresh();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        AuditNotifier.OnNewLog -= OnNewLogReceived;
    }

    private async Task ToggleScans()
    {
        HideScans = !HideScans;
        CurrentPage = 1;
        await Refresh();
    }

    private async Task ChangePageSize(int size)
    {
        PageSize = size;
        CurrentPage = 1;
        await Refresh();
    }

    private async Task GoToPage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        CurrentPage = page;
        await Refresh();
    }

    private async Task Unban(string ip)
    {
        var ban = await Db.BannedIps.FindAsync(ip);
        if (ban != null)
        {
            Db.BannedIps.Remove(ban);
            await Db.SaveChangesAsync();
            Toast.ShowSuccess($"IP {ip} pardonnée.");
            await Refresh();
        }
    }

    private string GetRowClass(AccessLog log)
    {
        if (log.AppName == "BOT_SCAN") return "table-secondary opacity-50";
        if (log.StatusCode >= 500) return "table-danger-hard";
        if (log.StatusCode == 401 || log.StatusCode == 403) return "table-auth-soft";
        if (log.StatusCode == 404) return "table-info-soft";
        if (log.StatusCode >= 400) return "table-warning-soft";
        return "";
    }

    private string GetStatusBadgeClass(int code)
    {
        if (code < 300) return "bg-success";
        if (code < 400) return "bg-info";
        if (code == 401 || code == 403) return "bg-primary";
        if (code == 404) return "bg-secondary";
        if (code < 500) return "bg-warning text-dark";
        return "bg-danger";
    }

    private string AnonymizeIp(string ip)
    {
        if (string.IsNullOrEmpty(ip) || ip.Contains("::") || ip == "Unknown") return ip;
        var parts = ip.Split('.');
        if (parts.Length == 4)
        {
            return $"{parts[0]}.{parts[1]}.{parts[2]}.*";
        }
        return ip;
    }

    private async Task Refresh()
    {
        try
        {
            var query = Db.AccessLogs.AsQueryable();

            if (HideScans)
            {
                query = query.Where(l => l.AppName != "BOT_SCAN" && l.AppName != "SECURITY_SHIELD");
            }

            if (!string.IsNullOrEmpty(FilterMethod))
            {
                query = query.Where(l => l.Method == FilterMethod);
            }

            if (!string.IsNullOrEmpty(FilterStatus))
            {
                if (int.TryParse(FilterStatus, out int status))
                {
                    query = query.Where(l => l.StatusCode == status);
                }
            }

            if (!string.IsNullOrEmpty(SearchTerm))
            {
                var t = SearchTerm.ToLower();
                query = query.Where(l => 
                    l.Path.ToLower().Contains(t) || 
                    l.ClientIp.Contains(t) || 
                    l.AppName.ToLower().Contains(t) || 
                    l.ResultStatus.ToLower().Contains(t)
                );
            }

            TotalCount = await query.CountAsync();
            
            // Securité si la page courante est hors limites après filtrage
            if (CurrentPage > TotalPages && TotalPages > 0) CurrentPage = TotalPages;
            if (CurrentPage < 1) CurrentPage = 1;

            Logs = await query.OrderByDescending(l => l.Timestamp)
                              .Skip((CurrentPage - 1) * PageSize)
                              .Take(PageSize)
                              .ToListAsync();

            // 2. IPs Bannies
            BannedIps = await Db.BannedIps.OrderByDescending(b => b.BannedAt).ToListAsync();
            foreach (var ban in BannedIps)
            {
                if (!ResolvedBans.ContainsKey(ban.IpAddress))
                {
                    ResolvedBans[ban.IpAddress] = await GeoIp.GetGeoInfoAsync(ban.IpAddress);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing logs: {ex.Message}");
        }
    }
}
