@page "/settings"
@inject LicenseDbContext Db
@inject SoftLicence.Server.Services.ToastService Toast
@inject SoftLicence.Server.Services.EmailService Mailer
@inject SoftLicence.Server.Services.NotificationService Notifier
@inject IHttpClientFactory HttpFactory
@inject Microsoft.Extensions.Options.IOptions<SoftLicence.Server.Services.SmtpSettings> SmtpOptions
@inject SoftLicence.Server.Services.SettingsService Settings
@inject SoftLicence.Server.Services.GeoIpService GeoIp
@inject SoftLicence.Server.Services.TimeZoneService TZ
@using Microsoft.EntityFrameworkCore
@using SoftLicence.Server.Components.Shared
@using SoftLicence.Server.Services
@using SoftLicence.Server.Data
@using SoftLicence.Server.Models
@inject IStringLocalizer<SharedResource> L

<h3>@L["Maintenance_Title"]</h3>

<div class="row mt-4 g-3">
    <!-- GESTION DES WEBHOOKS (NOTIFICATIONS) -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="text-info">@L["Maintenance_Webhooks"]</h5>
                <p class="text-muted small">@L["Maintenance_WebhooksDesc"]</p>

                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <input class="form-control form-control-sm" placeholder="@L["Maintenance_WebhookNamePlaceholder"]" @bind="newHookName" />
                    </div>
                    <div class="col-md-5">
                        <input class="form-control form-control-sm" placeholder="@L["Maintenance_WebhookUrlPlaceholder"]" @bind="newHookUrl" />
                    </div>
                    <div class="col-md-4">
                        <div class="border border-secondary rounded p-2 bg-black" style="max-height: 120px; overflow-y: auto;">
                            @foreach (var kvp in NotificationService.AvailableTriggers)
                            {
                                <div class="form-check mb-1">
                                    <input class="form-check-input" type="checkbox" id="trig_@kvp.Key" 
                                           checked="@selectedTriggers.Contains(kvp.Key)" 
                                           @onchange="@(e => ToggleTrigger(kvp.Key, e.Value))">
                                    <label class="form-check-label text-light small" for="trig_@kvp.Key">@kvp.Value</label>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="col-12 text-end">
                        <button class="btn btn-info btn-sm" @onclick="CreateWebhook">@L["Maintenance_CreateWebhook"]</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-dark table-hover align-middle">
                        <thead>
                            <tr>
                                <th>@L["Common_Status"]</th>
                                <th>@L["Common_Name"]</th>
                                <th>@L["Maintenance_URL"]</th>
                                <th>@L["Maintenance_Events"]</th>
                                <th>@L["Maintenance_Last"]</th>
                                <th>@L["Common_Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var hook in Webhooks)
                            {
                                <tr>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" checked="@hook.IsEnabled" @onchange="@(e => ToggleWebhook(hook, e.Value))">
                                        </div>
                                    </td>
                                    <td>@hook.Name</td>
                                    <td>
                                        <div class="text-truncate small" style="max-width: 150px;" title="@hook.Url">@hook.Url</div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-wrap gap-1">
                                            @foreach(var evt in (hook.EnabledEvents ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries))
                                            {
                                                string display = evt;
                                                if (NotificationService.AvailableTriggers.TryGetValue(evt, out var friendly)) {
                                                    display = friendly;
                                                } else {
                                                    display = evt.Split('.').Last();
                                                }
                                                <span class="badge bg-secondary" style="font-size: 0.6rem;">@display</span>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(hook.LastError))
                                        {
                                            <div class="text-danger small mt-1" title="@hook.LastError">‚ö†Ô∏è @hook.LastError</div>
                                        }
                                    </td>
                                    <td class="small">
                                        @if (hook.LastTriggeredAt.HasValue)
                                        {
                                            <span class="text-success">@TZ.ToLocal(hook.LastTriggeredAt.Value).ToString("g")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-light" title="Tester" @onclick="() => TestWebhook(hook)">‚ö°</button>
                                        <button class="btn btn-sm btn-outline-danger ms-1" title="Supprimer" @onclick="() => RequestDeleteWebhook(hook)">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JOURNAL D'AUDIT & TELEMETRIE -->
    <div class="col-md-4">
        <div class="card border-danger h-100 shadow-sm">
            <div class="card-body">
                <h5 class="text-danger">@L["Maintenance_AuditLog"]</h5>
                <p class="text-muted small">@L["Maintenance_AuditLogDesc"]</p>
                <button class="btn btn-outline-danger mt-3 w-100" @onclick="() => modalAudit.Show()">@L["Maintenance_ClearLog"]</button>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-danger h-100 shadow-sm">
            <div class="card-body">
                <h5 class="text-danger">@L["Maintenance_TelemetryTitle"]</h5>
                <p class="text-muted small">@L["Maintenance_TelemetryDesc"]</p>
                <button class="btn btn-outline-danger mt-3 w-100" @onclick="() => modalTelemetry.Show()">@L["Maintenance_ClearTelemetry"]</button>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-danger h-100 shadow-sm">
            <div class="card-body">
                <h5 class="text-danger">@L["Maintenance_ResetDbTitle"]</h5>
                <p class="text-muted small">@L["Maintenance_ResetDbDesc"]</p>
                <button class="btn btn-outline-danger mt-3 w-100" @onclick="() => showResetDbModal = true">@L["Maintenance_ResetDbBtn"]</button>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <h5 class="text-primary">@L["Maintenance_SmtpConfig"]</h5>
                <p class="text-muted small">@L["Maintenance_SmtpDesc"]</p>
                
                <div class="bg-black p-2 rounded border border-secondary mb-3" style="font-size: 0.7rem; font-family: monospace;">
                    <div class="text-muted">@L["Maintenance_CurrentConfig"]</div>
                    <div>Host : <span class="text-info">@SmtpOptions.Value.Host</span></div>
                    <div>Port : <span class="text-info">@SmtpOptions.Value.Port</span></div>
                    <div>User : <span class="text-info">@(string.IsNullOrEmpty(SmtpOptions.Value.Username) ? "(aucun)" : SmtpOptions.Value.Username)</span></div>
                    <div>SSL  : <span class="text-info">@SmtpOptions.Value.EnableSsl</span></div>
                </div>

                <div class="mt-3">
                    <div class="input-group mb-2">
                        <input class="form-control form-control-sm" placeholder="@L["Maintenance_DestEmail"]" @bind="testEmail" />
                        <button class="btn btn-primary btn-sm" @onclick="TestSmtp" disabled="@isSending">
                            @if(isSending) { <span class="spinner-border spinner-border-sm"></span> }
                            @L["Common_Test"]
                        </button>
                    </div>

                    @if (smtpLogs.Any())
                    {
                        <div class="mt-3 p-2 bg-black rounded border border-secondary" style="font-family: monospace; font-size: 0.75rem; max-height: 200px; overflow-y: auto;">
                            @foreach (var log in smtpLogs)
                            {
                                <div class="@(log.Contains("ERREUR") ? "text-danger" : log.Contains("succ√®s") ? "text-success" : "text-info")">
                                    > @log
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- SECURITE API -->
    <div class="col-md-4">
        <div class="card border-warning h-100 shadow-sm">
            <div class="card-body">
                <h5 class="text-warning">Cl√© API globale</h5>
                <p class="text-muted small">
                    La cl√© API globale (configur√©e dans Docker) permet un acc√®s complet √† tous les produits.
                    D√©sactivez-la si vous n'en avez pas besoin ‚Äî les secrets par produit continueront de fonctionner.
                </p>
                <div class="d-flex align-items-center gap-3 mt-3">
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" id="globalApiToggle"
                               checked="@globalApiSecretEnabled"
                               @onchange="ToggleGlobalApiSecret" />
                        <label class="form-check-label text-white" for="globalApiToggle">
                            @(globalApiSecretEnabled ? "Activ√©e" : "D√©sactiv√©e")
                        </label>
                    </div>
                    @if (!globalApiSecretEnabled)
                    {
                        <span class="badge bg-danger">Acc√®s global bloqu√©</span>
                    }
                    else
                    {
                        <span class="badge bg-warning text-dark">Acc√®s global autoris√©</span>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-black { background-color: #000 !important; }
    .dropdown-menu.show { display: block; }
</style>

<ConfirmModal @ref="modalAudit" 
              Title="@L["Maintenance_ClearAuditTitle"]"
              Message="@L["Maintenance_ClearAuditMsg"]" 
              OnClose="OnAuditConfirm" />

<ConfirmModal @ref="modalTelemetry" 
              Title="@L["Maintenance_ClearTelemetryTitle"]"
              Message="@L["Maintenance_ClearTelemetryMsg"]" 
              OnClose="OnTelemetryConfirm" />

@if (showResetDbModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.7);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-danger">
                <div class="modal-header border-danger">
                    <h5 class="modal-title text-danger">@L["Maintenance_ResetDbConfirmTitle"]</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => { showResetDbModal = false; resetDbInput = string.Empty; }"></button>
                </div>
                <div class="modal-body">
                    <p class="text-warning mb-3">@L["Maintenance_ResetDbConfirmMsg"]</p>
                    
                    <div class="bg-black p-3 rounded border border-secondary mb-3">
                        <h6 class="text-muted small text-uppercase fw-bold mb-3">@L["Maintenance_ResetSelection"]</h6>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="reset_lic" @bind="resetLicenses" disabled="@resetProducts">
                            <label class="form-check-label text-white small" for="reset_lic">
                                @L["Nav_Licenses"] <span class="text-muted">(Keys, Seats, History)</span>
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="reset_audit" @bind="resetAudit">
                            <label class="form-check-label text-white small" for="reset_audit">
                                @L["Nav_Audit"] <span class="text-muted">(Access Logs)</span>
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="reset_tel" @bind="resetTelemetry">
                            <label class="form-check-label text-white small" for="reset_tel">
                                @L["Nav_Telemetry"]
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="reset_bans" @bind="resetBans">
                            <label class="form-check-label text-white small" for="reset_bans">
                                @L["Audit_ActiveBans"]
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="reset_hooks" @bind="resetWebhooks">
                            <label class="form-check-label text-white small" for="reset_hooks">
                                @L["Maintenance_Webhooks"]
                            </label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="reset_prod" 
                                   @bind:get="resetProducts" 
                                   @bind:set="@(v => { resetProducts = v; if(v) resetLicenses = true; })">
                            <label class="form-check-label text-danger small fw-bold" for="reset_prod">
                                @L["Nav_Software"] <span class="text-muted small font-italic">(@L["Products_KeyLossWarning"])</span>
                            </label>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label small text-muted">@L["Maintenance_ResetDbConfirmHint"]</label>
                        <input class="form-control form-control-sm bg-black text-danger font-monospace" @bind="resetDbInput" @bind:event="oninput" />
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-secondary" @onclick="() => { showResetDbModal = false; resetDbInput = string.Empty; }">@L["Common_Cancel"]</button>
                    <button class="btn btn-danger" disabled="@(resetDbInput != L["Maintenance_ResetDbConfirmPhrase"].Value)" @onclick="ExecuteResetDb">@L["Maintenance_ResetDbBtn"]</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Webhook> Webhooks = new();

    // Webhooks
    private string newHookName = "";
    private string newHookUrl = "";
    private HashSet<string> selectedTriggers = new();

    private ConfirmModal modalAudit = default!;
    private ConfirmModal modalTelemetry = default!;

    // Reset DB
    private bool showResetDbModal = false;
    private string resetDbInput = "";
    private bool resetLicenses = true;
    private bool resetAudit = false;
    private bool resetTelemetry = false;
    private bool resetBans = false;
    private bool resetWebhooks = false;
    private bool resetProducts = false;

    private string testEmail = "";
    private bool isSending = false;
    private List<string> smtpLogs = new();

    private bool globalApiSecretEnabled = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        Webhooks = await Db.Webhooks.OrderByDescending(w => w.CreatedAt).ToListAsync();
        globalApiSecretEnabled = await Settings.GetBoolSettingAsync("GlobalApiSecretEnabled", true);
    }

    private async Task ToggleGlobalApiSecret(ChangeEventArgs e)
    {
        globalApiSecretEnabled = e.Value is bool b && b;
        await Settings.SetSettingAsync("GlobalApiSecretEnabled", globalApiSecretEnabled.ToString());
        Toast.ShowSuccess(globalApiSecretEnabled ? "Cl√© API globale activ√©e." : "Cl√© API globale d√©sactiv√©e.");
    }

    // --- WEBHOOKS LOGIC ---

    private void ToggleTrigger(string trigger, object? value)
    {
        if (value is bool b && b) selectedTriggers.Add(trigger);
        else selectedTriggers.Remove(trigger);
    }

    private async Task CreateWebhook()
    {
        if (string.IsNullOrWhiteSpace(newHookName) || string.IsNullOrWhiteSpace(newHookUrl))
        {
            Toast.ShowError("Nom et URL requis."); return;
        }
        if (!selectedTriggers.Any())
        {
            Toast.ShowError("S√©lectionnez au moins un d√©clencheur."); return;
        }

        var hook = new Webhook 
        { 
            Name = newHookName, 
            Url = newHookUrl,
            EnabledEvents = string.Join(",", selectedTriggers)
        };

        Db.Webhooks.Add(hook);
        await Db.SaveChangesAsync();
        Toast.ShowSuccess("Webhook cr√©√© !");
        
        newHookName = ""; newHookUrl = ""; selectedTriggers.Clear();
        await LoadData();
    }

    private async Task ToggleWebhook(Webhook hook, object? value)
    {
        if (value is bool b)
        {
            hook.IsEnabled = b;
            await Db.SaveChangesAsync();
        }
    }

    private async Task RequestDeleteWebhook(Webhook hook)
    {
        Db.Webhooks.Remove(hook);
        await Db.SaveChangesAsync();
        Toast.ShowSuccess("Webhook supprim√©.");
        await LoadData();
    }

    private async Task TestWebhook(Webhook hook)
    {
        try
        {
            var client = HttpFactory.CreateClient();
            var payload = new { title = "Test Webhook", message = "Ceci est un test manuel depuis l'interface admin.", timestamp = DateTime.UtcNow };
            
            if (hook.Url.Contains("ntfy"))
            {
                var req = new HttpRequestMessage(HttpMethod.Post, hook.Url);
                req.Content = new StringContent(payload.message);
                req.Headers.Add("Title", payload.title);
                req.Headers.Add("Tags", "zap");
                await client.SendAsync(req);
            }
            else
            {
                await client.PostAsJsonAsync(hook.Url, payload);
            }

            Toast.ShowSuccess("Test envoy√© avec succ√®s !");
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Erreur test : {ex.Message}");
        }
    }

    // --- END WEBHOOKS ---

    private async Task OnAuditConfirm(bool confirmed)
    {
        if (confirmed)
        {
            try 
            {
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"AccessLogs\"");
                Toast.ShowSuccess("Le journal d'audit a √©t√© vid√©.");
            }
            catch (Exception ex) { Toast.ShowError($"Erreur : {ex.Message}"); }
        }
    }

    private async Task OnTelemetryConfirm(bool confirmed)
    {
        if (confirmed)
        {
            try 
            {
                // La suppression en cascade s'occupe des tables liees (Events, Diagnostics, Errors)
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"TelemetryRecords\"");
                Toast.ShowSuccess("La t√©l√©m√©trie a √©t√© vid√©e.");
            }
            catch (Exception ex) { Toast.ShowError($"Erreur : {ex.Message}"); }
        }
    }

    private async Task TestSmtp()
    {
        if (string.IsNullOrWhiteSpace(testEmail)) { Toast.ShowError("Veuillez saisir un email."); return; }

        isSending = true;
        smtpLogs.Clear();
        smtpLogs.Add("D√©marrage du diagnostic SMTP...");
        StateHasChanged();

        try
        {
            await Mailer.RunDiagnosticAsync(testEmail, "Admin", "TEST SYSTEM", "CLE-TEST-1234", async (msg) => {
                smtpLogs.Add(msg);
                await InvokeAsync(StateHasChanged);
            });
            Toast.ShowSuccess("Diagnostic termin√© avec succ√®s !");
        }
        catch (Exception ex)
        {
            Toast.ShowError("Le diagnostic a √©chou√©.");
            Console.WriteLine($"[SMTP ERROR] {ex}");
        }
        finally { isSending = false; }
    }

    private async Task ExecuteResetDb()
    {
        showResetDbModal = false;
        resetDbInput = "";

        try
        {
            // Ordre respectant les FK (enfants d'abord)
            if (resetLicenses || resetProducts)
            {
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"LicenseHistories\"");
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"LicenseSeats\"");
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"LicenseRenewals\"");
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"Licenses\"");
            }

            if (resetAudit)
            {
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"AccessLogs\"");
            }

            if (resetBans)
            {
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"BannedIps\"");
            }

            if (resetTelemetry)
            {
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"TelemetryRecords\"");
            }

            if (resetWebhooks)
            {
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"Webhooks\"");
            }

            if (resetProducts)
            {
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"Products\"");
                await Db.Database.ExecuteSqlRawAsync("DELETE FROM \"LicenseTypes\"");
            }

            Toast.ShowSuccess(L["Maintenance_ResetDbSuccess"]);
            await LoadData();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"{L["Common_Error"]} : {ex.Message}");
        }
    }
}
