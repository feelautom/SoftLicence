@page "/docs"
@rendermode RenderMode.InteractiveServer
@inject IStringLocalizer<SharedResource> L

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>@L["Docs_Title"]</h3>
    <span class="badge bg-primary">Version 1.1</span>
</div>

<div class="card p-0 mt-4 overflow-hidden border-0">
    <div class="bg-dark p-2 border-bottom border-secondary">
        <ul class="nav nav-pills" id="docTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link @(activeTab == "client" ? "active" : "")" @onclick="@(() => activeTab = "client")">@L["Docs_WpfIntegration"]</button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == "server" ? "active" : "")" @onclick="@(() => activeTab = "server")">@L["Docs_Administration"]</button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == "security" ? "active" : "")" @onclick="@(() => activeTab = "security")">@L["Docs_SecurityAudit"]</button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == "api" ? "active" : "")" @onclick="@(() => activeTab = "api")">@L["Docs_ApiReference"]</button>
            </li>
        </ul>
    </div>

    <div class="card-body p-4 bg-card">
        @if (activeTab == "client")
        {
            <div class="doc-content animate-fade">
                <h4>üöÄ Int√©gration dans votre logiciel</h4>
                <p>Pour prot√©ger une application, suivez ces √©tapes :</p>
                <ol>
                    <li>R√©cup√©rez la <strong>Cl√© Publique XML</strong> du logiciel sur ce dashboard.</li>
                    <li>Utilisez le <code>LicenseActivationViewModel</code> dans votre <code>App.xaml.cs</code>.</li>
                    <li>Appelez <code>await vm.InitializeAsync()</code> au d√©marrage.</li>
                </ol>

                <h5 class="mt-4">Exemple App.xaml.cs</h5>
                <pre><code>// Dans OnStartup
var vm = new LicenseActivationViewModel(PublicKey, "MonApp", "https://votre-serveur.fr");
await vm.InitializeAsync();

if (vm.IsLicensed) { /* Lancer MainWindow */ }</code></pre>

                <h5 class="mt-4">V√©rification en temps r√©el (Live)</h5>
                <p>Le client int√®gre un timer qui v√©rifie la validit√© de la licence toutes les 2 heures. Si vous r√©voquez une licence sur ce dashboard, l'application du client se fermera automatiquement dans ce d√©lai.</p>
            </div>
        }
        else if (activeTab == "server")
        {
            <div class="doc-content animate-fade">
                <h4>üõ† Gestion du parc</h4>
                <h5 class="mt-3">Logiciels</h5>
                <p>Chaque logiciel poss√®de son propre couple de cl√©s RSA-4096. Ne partagez jamais la cl√© priv√©e (stock√©e en base).</p>

                <h5 class="mt-3">Types de licences</h5>
                <p>Chaque produit peut d√©finir plusieurs types de licences, identifi√©s par un <strong>Slug</strong> (ex : <code>YOUR_APP_NAME-PRO</code>, <code>YOUR_APP_NAME-COMMUNITY</code>). Deux modes de fonctionnement existent :</p>
                <ul>
                    <li><span class="badge bg-secondary">FIXE</span> ‚Äî Dur√©e fixe non renouvelable (<code>IsRecurring = false</code>). Utilis√© pour les <strong>versions Trial</strong> : une fois expir√©e, le Hardware ID ne peut plus obtenir de nouvelle licence de ce type. C'est le comportement par d√©faut.</li>
                    <li><span class="badge bg-primary">ABONNEMENT</span> ‚Äî Dur√©e renouvelable automatiquement (<code>IsRecurring = true</code>). Utilis√© pour les <strong>versions Community</strong> : √† chaque expiration, le client redemande une licence via l'endpoint <code>/api/activation/trial</code> et le serveur prolonge automatiquement la p√©riode sans cr√©er de nouvelle entr√©e. L'historique enregistre un √©v√©nement <code>RENEWED</code>.</li>
                </ul>
                <p>Le mode s'active en cochant <strong>Abonnement</strong> lors de la cr√©ation ou de l'√©dition d'un type de licence dans l'onglet Produits.</p>

                <h5 class="mt-3">Licences</h5>
                <p>Une licence est li√©e √† un <strong>Hardware ID</strong> unique lors de sa premi√®re activation. Le client ne pourra pas copier son fichier de licence sur un autre PC.</p>

                <h5 class="mt-3">R√©initialisation (Reset HWID)</h5>
                <p>Si un client change de mat√©riel, utilisez le bouton "Reset HWID" pour lui permettre de r√©-associer sa licence √† sa nouvelle machine.</p>
            </div>
        }
        else if (activeTab == "security")
        {
            <div class="doc-content animate-fade">
                <h4>üõ° Protection & surveillance</h4>
                
                <h5 class="mt-3 text-warning">Obfuscation (Obfuscar)</h5>
                <p>Pour prot√©ger votre code contre la d√©compilation (dnSpy), utilisez le fichier <code>obfuscar.xml</code> fourni dans les exemples.</p>

                <h5 class="mt-4 text-info">Audit Log (Middleware)</h5>
                <p>Toutes les requ√™tes vers l'API sont loggu√©es dans l'onglet <strong>Audit</strong>. Nous capturons l'IP r√©elle, la dur√©e et le statut HTTP.</p>
            </div>
        }
        else if (activeTab == "api")
        {
            <div class="doc-content animate-fade">
                <h4>üì° API reference</h4>
                <p>Toutes les requ√™tes doivent √™tre envoy√©es avec le header <code>Content-Type: application/json</code>.</p>

                <h5 class="text-info mt-4">1. Activation (Public)</h5>
                <div class="api-box">
                    <span class="badge bg-success">POST</span> <code>/api/activation</code>
                    <p class="mt-2">Active une licence sur une machine.</p>
                    <strong>Param√®tres (JSON) :</strong>
                    <pre><code>{
  "LicenseKey": "AAAA-BBBB-CCCC",
  "HardwareId": "ABC-123-XYZ",
  "AppName": "MySoftware"
}</code></pre>
                </div>

                <h5 class="text-info mt-4">2. V√©rification Statut (Public)</h5>
                <div class="api-box">
                    <span class="badge bg-success">POST</span> <code>/api/activation/check</code>
                    <p class="mt-2">V√©rifie si une licence est toujours valide.</p>
                </div>

                <h5 class="text-warning mt-4">3. Gestion (Admin)</h5>
                <p class="small italic">N√©cessite le header <code>X-Admin-Secret</code>.</p>
                
                <div class="api-box">
                    <span class="badge bg-success">POST</span> <code>/api/admin/licenses</code>
                    <p class="mt-2">G√©n√®re une nouvelle licence.</p>
                    <strong>Param√®tres (JSON) :</strong>
                    <pre><code>{
  "ProductName": "MySoftware",
  "CustomerName": "Jean Dupont",
  "CustomerEmail": "jean@mail.com",
  "TypeSlug": "PRO",
  "DaysValidity": 365,
  "Reference": "STRIPE-123"
}</code></pre>
                    <p class="small text-muted mt-1"><code>Reference</code> est optionnel : ID de commande, r√©f√©rence client, etc. Ce champ est inclus dans le fichier de licence sign√©.</p>
                </div>

                <h5 class="text-info mt-4">3b. Trial / Community (Public)</h5>
                <p class="small">Permet √† un client d'obtenir automatiquement une licence gratuite (Trial ou Community) sans cl√© d'activation. Le type de licence est d√©termin√© par le <code>TypeSlug</code> configur√© sur le produit.</p>

                <div class="api-box">
                    <span class="badge bg-success">POST</span> <code>/api/activation/trial</code>
                    <p class="mt-2">Cr√©e ou renouvelle une licence gratuite pour la machine courante.</p>
                    <strong>Param√®tres (JSON) :</strong>
                    <pre><code>{
  "HardwareId": "ABC-123-XYZ",
  "AppName": "MySoftware",
  "AppId": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "TypeSlug": "YOUR_APP_NAME-COMMUNITY",
  "AppVersion": "1.0.0"
}</code></pre>
                    <strong>Comportement selon le mode :</strong>
                    <ul class="mt-2">
                        <li><span class="badge bg-secondary">FIXE</span> ‚Äî Cr√©e une licence une seule fois. Si elle est expir√©e, retourne une erreur : le Trial ne peut pas √™tre renouvel√©.</li>
                        <li><span class="badge bg-primary">ABONNEMENT</span> ‚Äî Cr√©e la licence √† la premi√®re demande. Si elle est expir√©e, <strong>prolonge automatiquement</strong> la date d'expiration de <code>DefaultDurationDays</code> jours suppl√©mentaires et retourne la licence mise √† jour.</li>
                    </ul>
                    <p class="small text-muted mt-2">Si le <code>TypeSlug</code> n'existe pas sur le produit, l'appel retourne HTTP 400. Un slug doit √™tre explicitement configur√© pour autoriser ce mode de licence.</p>
                </div>

                <h5 class="text-info mt-4">4. R√©initialisation (Public)</h5>
                <p class="small">Permet √† un utilisateur de d√©lier sa licence pour l'utiliser sur un autre poste (Self-Service).</p>
                
                <div class="api-box">
                    <span class="badge bg-success">POST</span> <code>/api/activation/reset-request</code>
                    <p class="mt-2">Demande l'envoi d'un code de r√©initialisation par email.</p>
                    <strong>Param√®tres (JSON) :</strong>
                    <pre><code>{
  "LicenseKey": "AAAA-BBBB-CCCC",
  "AppName": "MySoftware"
}</code></pre>
                </div>

                <div class="api-box mt-3">
                    <span class="badge bg-success">POST</span> <code>/api/activation/reset-confirm</code>
                    <p class="mt-2">Valide le reset avec le code re√ßu par email.</p>
                    <strong>Param√®tres (JSON) :</strong>
                    <pre><code>{
  "LicenseKey": "AAAA-BBBB-CCCC",
  "AppName": "MySoftware",
  "ResetCode": "123456"
}</code></pre>
                </div>

                <h5 class="text-info mt-4">5. Lecture T√©l√©m√©trie (Public / API Key)</h5>
                <p class="small">Permet de r√©cup√©rer les donn√©es de t√©l√©m√©trie d'un produit pour les afficher sur un site externe.</p>
                
                <div class="api-box">
                    <span class="badge bg-primary">GET</span> <code>/api/telemetry</code>
                    <p class="mt-2">R√©cup√®re la liste pagin√©e des √©v√©nements.</p>
                    <strong>Header requis :</strong>
                    <pre><code>X-Product-Key: &lt;VOTRE_API_SECRET_PRODUIT&gt;</code></pre>
                    <strong>Param√®tres optionnels (Query) :</strong>
                    <ul>
                        <li><code>page</code> : Num√©ro de page (d√©faut: 1)</li>
                        <li><code>pageSize</code> : Taille de page (d√©faut: 50)</li>
                        <li><code>type</code> : Filtre (Event, Diagnostic, Error)</li>
                    </ul>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .doc-content h4 { color: var(--accent-color); font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
    .doc-content h5 { font-size: 1.1rem; font-weight: 600; margin-top: 25px; }
    .doc-content li { color: #ffffff !important; }
    .doc-content p { color: #e0e0e0 !important; }
    .doc-content pre { background: #000; padding: 15px; border-radius: 8px; border: 1px solid #333; color: #00ff00; font-family: 'Consolas', monospace; font-size: 0.9rem; }
    .api-box { background: #1a1a1a; padding: 15px; border-left: 4px solid #0d6efd; border-radius: 0 8px 8px 0; margin-top: 10px; }
    .nav-pills .nav-link { color: #aaa; border-radius: 5px; margin-right: 5px; cursor: pointer; }
    .nav-pills .nav-link.active { background-color: var(--accent-color) !important; color: #fff; }
    .animate-fade { animation: fadeIn 0.3s; }
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

@code {
    private string activeTab = "client";
}
