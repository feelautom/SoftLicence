@page "/licenses"
@inject SoftLicence.Server.Services.AuthService Auth
@inject LicenseDbContext Db
@inject IDbContextFactory<LicenseDbContext> DbFactory
@inject IJSRuntime JS
@inject SoftLicence.Server.Services.ToastService Toast
@inject SoftLicence.Server.Services.EmailService Mailer
@inject SoftLicence.Server.Services.TimeZoneService TZ
@using SoftLicence.SDK
@using Microsoft.EntityFrameworkCore
@using SoftLicence.Server.Components.Shared
@using SoftLicence.Server.Data
@inject IStringLocalizer<SharedResource> L

<div class="container-fluid animate-fade">
    @if (!isAuthorized)
    {
        <div class="text-center py-5">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger mb-4"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg>
            <h2 class="text-white">@L["Common_AccessDenied"]</h2>
            <p class="text-muted">@L["Common_NoPermissionLicenses"]</p>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>@L["Licenses_Title"]</h3>
            <button class="btn btn-primary" @onclick="() => showCreate = !showCreate">
                @(showCreate ? L["Common_Cancel"] : L["Licenses_Generate"])
            </button>
        </div>

        @if (showCreate)
        {
            <div class="card p-3 mb-4 animate-fade">
                <h5>@L["Licenses_New"]</h5>
                <div class="row g-2 mt-2">
                    <div class="col-md-2">
                        <label class="small text-muted">@L["Licenses_Software"]</label>
                        <select class="form-select form-select-sm" @bind="SelectedProductId">
                            <option value="">@L["Common_Select"]</option>
                            @foreach (var p in Products)
                            {
                                <option value="@p.Id">@p.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">@L["Licenses_Client"]</label>
                        <input class="form-control form-control-sm" placeholder="@L["Licenses_NamePlaceholder"]" @bind="NewClientName" />
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">@L["Licenses_Email"]</label>
                        <input class="form-control form-control-sm" type="email" placeholder="@L["Licenses_EmailPlaceholder"]" @bind="NewClientEmail" />
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">@L["Common_Type"]</label>
                        <select class="form-select form-select-sm" @bind="SelectedTypeId">
                            <option value="">@L["Common_Select"]</option>
                            @foreach (var t in LicenseTypes)
                            {
                                <option value="@t.Id">@t.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="small text-muted">@L["Licenses_Days"]</label>
                        <input class="form-control form-control-sm" type="number" placeholder="365" @bind="newValidityDays" />
                    </div>
                    <div class="col-md-1">
                        <label class="small text-muted">@L["Licenses_Seats"]</label>
                        <input class="form-control form-control-sm" type="number" @bind="newMaxSeats" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-success btn-sm w-100" @onclick="CreateLicense">@L["Licenses_GenerateKey"]</button>
                    </div>
                </div>
            </div>
        }

        @if (GeneratedKey != null)
        {
            <div class="alert alert-success border-success animate-pop">
                <strong>@L["Licenses_Created"]</strong>
                <div class="input-group mt-2">
                    <input class="form-control fw-bold bg-dark text-success font-monospace" value="@GeneratedKey" readonly />
                    <button class="btn btn-outline-secondary" @onclick="() => GeneratedKey = null">@L["Common_Close"]</button>
                </div>
            </div>
        }

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>@L["Licenses_Software"]</th>
                        <th>@L["Licenses_Client"]</th>
                        <th>@L["Licenses_Key"]</th>
                        <th>@L["Licenses_HardwareId"]</th>
                        <th>@L["Common_Type"]</th>
                        <th>@L["Common_Status"]</th>
                        <th class="text-center">@L["Licenses_Recovery"]</th>
                        <th>@L["Licenses_Reference"]</th>
                        <th class="text-center">@L["Licenses_Seats"]</th>
                        <th class="text-end">@L["Common_Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var l in LicensesList)
                    {
                        <tr>
                            <td class="fw-bold">@l.Product?.Name</td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span>@l.CustomerName</span>
                                    <small class="text-muted">@l.CustomerEmail</small>
                                </div>
                            </td>
                            <td>
                                <code class="text-muted small" style="cursor:pointer" title="Cliquer pour copier" @onclick="() => CopyToClipboard(l.LicenseKey)">@l.LicenseKey</code>
                            </td>
                            <td>
                                @{
                                    var hwId = l.Seats?.FirstOrDefault(s => s.IsActive)?.HardwareId ?? l.HardwareId;
                                }
                                @if (!string.IsNullOrEmpty(hwId))
                                {
                                    <code class="text-info small" style="cursor:pointer" title="Cliquer pour copier" @onclick="() => CopyToClipboard(hwId)">@hwId</code>
                                }
                                else
                                {
                                    <span class="text-muted small">-</span>
                                }
                            </td>
                            <td><span class="badge border border-secondary text-info">@l.Type?.Slug</span></td>
                            <td>
                                @if (l.IsActive) { <span class="text-success small">● @L["Common_Active"]</span> }
                                else { 
                                    <div class="d-flex flex-column">
                                        <span class="text-danger small">● @L["Licenses_Revoked"]</span>
                                        @if(!string.IsNullOrEmpty(l.RevocationReason)) {
                                            <small class="text-muted" style="font-size: 0.65rem; max-width: 150px;">@l.RevocationReason</small>
                                        }
                                    </div>
                                }
                            </td>
                            <td class="text-center">
                                @if (l.RecoveryCount > 0)
                                {
                                    <span class="badge rounded-pill bg-warning text-dark">@l.RecoveryCount</span>
                                }
                                else { <span class="text-muted small">-</span> }
                            </td>
                            <td>
                                <span class="text-muted small">@(string.IsNullOrEmpty(l.Reference) ? "-" : l.Reference)</span>
                            </td>
                            <td class="text-center">
                                @{
                                    var used = l.Seats?.Count(s => s.IsActive) ?? 0;
                                    var color = used >= l.MaxSeats ? "text-warning" : "text-success";
                                }
                                <div class="d-flex flex-column align-items-center" style="cursor: pointer" @onclick="() => ToggleSeats(l.Id)">
                                    <span class="fw-bold @color">@used / @l.MaxSeats</span>
                                    <small class="text-muted" style="font-size: 0.7rem">@L["Licenses_SeatDetails"] ▾</small>
                                </div>
                            </td>
                            <td class="text-end">
                                <div class="d-flex gap-2 justify-content-end">
                                    @if (l.IsActive)
                                    {
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmRevoke(l)" title="@L["Licenses_Revoked"]">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-slash-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M11.354 4.646a.5.5 0 0 0-.708 0l-6 6a.5.5 0 0 0 .708.708l6-6a.5.5 0 0 0 0-.708z"/></svg>
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-success" @onclick="() => Reactivate(l)">@L["Licenses_Reactivate"]</button>
                                    }
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => ConfirmDelete(l)" title="Supprimer définitivement">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        @if (ExpandedLicenseId == l.Id)
                        {
                            <tr class="bg-dark bg-opacity-25 animate-fade">
                                <td colspan="10" class="p-0 border-start border-4 border-primary">
                                    <div class="card bg-transparent border-0">
                                        <div class="card-header bg-dark bg-opacity-50 py-1">
                                            <ul class="nav nav-tabs card-header-tabs border-0" role="tablist">
                                                <li class="nav-item">
                                                    <button class="nav-link py-1 small @(activeDetailTab == "seats" ? "active" : "")" @onclick='() => activeDetailTab = "seats"'>
                                                        @L["Licenses_ActivatedSeats"]
                                                    </button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link py-1 small @(activeDetailTab == "history" ? "active" : "")" @onclick="() => SwitchToHistoryTab(l)">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-heart-pulse me-1" viewBox="0 0 16 16"><path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/><path d="M5 8h2l1 2 1.5-3 1.5 1h2"/></svg>
                                                        @L["Licenses_LifeCycleTitle"]
                                                    </button>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="card-body p-3">
                                            @if (activeDetailTab == "seats")
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="mb-0 text-primary">@L["Licenses_ActivatedSeats"] (@(l.Seats?.Count(s => s.IsActive) ?? 0))</h6>
                                                    <button class="btn btn-sm btn-outline-warning" @onclick="() => ConfirmGlobalReset(l)">@L["Licenses_GlobalReset"]</button>
                                                </div>
                                                
                                                <!-- POSTES ACTIFS -->
                                                @if (l.Seats == null || !l.Seats.Any(s => s.IsActive))
                                                {
                                                    <p class="text-muted small italic m-0">@L["Licenses_NoSeats"]</p>
                                                }
                                                else
                                                {
                                                    <div class="row row-cols-1 row-cols-md-2 g-2">
                                                        @foreach (var seat in l.Seats.Where(s => s.IsActive))
                                                        {
                                                            <div class="col">
                                                                <div class="card bg-dark border-secondary p-2 d-flex flex-row justify-content-between align-items-center shadow-sm">
                                                                    <div>
                                                                        <code class="text-info small">@seat.HardwareId</code>
                                                                        <div class="text-muted" style="font-size: 0.7rem;">
                                                                            @L["Licenses_ActivatedOn"] @TZ.ToLocal(seat.FirstActivatedAt).ToString("dd/MM/yyyy HH:mm") |
                                                                            @L["Licenses_LastSeen"] @(DateTime.UtcNow.Subtract(seat.LastCheckInAt).TotalMinutes < 5 ? L["Licenses_Online"].Value : TZ.ToLocal(seat.LastCheckInAt).ToString("dd/MM/yyyy HH:mm"))
                                                                        </div>
                                                                    </div>
                                                                    <button class="btn btn-sm btn-link text-danger p-0" @onclick="() => DeleteSeat(seat)" title="@L["Licenses_UnlinkSeat"]">
                                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }

                                                <!-- HISTORIQUE SIMPLE (IDs déliés) -->
                                                @if (l.Seats != null && l.Seats.Any(s => !s.IsActive))
                                                {
                                                    <h6 class="mt-4 mb-2 text-muted small text-uppercase fw-bold">@L["Licenses_HistoryTitle"]</h6>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-dark border-secondary" style="font-size: 0.7rem;">
                                                            <thead>
                                                                <tr>
                                                                    <th>Hardware ID</th>
                                                                    <th>@L["Licenses_FirstActivation"]</th>
                                                                    <th>@L["Licenses_UnlinkDate"]</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var oldSeat in l.Seats.Where(s => !s.IsActive).OrderByDescending(s => s.UnlinkedAt))
                                                                {
                                                                    <tr class="opacity-75">
                                                                        <td><code class="text-secondary">@oldSeat.HardwareId</code></td>
                                                                        <td>@TZ.ToLocal(oldSeat.FirstActivatedAt).ToString("dd/MM/yyyy HH:mm")</td>
                                                                        <td class="text-warning">@TZ.ToLocal(oldSeat.UnlinkedAt ?? DateTime.MinValue).ToString("dd/MM/yyyy HH:mm")</td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                }
                                            }
                                            else if (activeDetailTab == "history")
                                            {
                                                <div class="animate-fade">
                                                    <h6 class="mb-3 text-info">@L["Licenses_ImmutableHistory"]</h6>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-dark table-hover" style="font-size: 0.75rem;">
                                                            <thead>
                                                                <tr>
                                                                    <th style="width: 150px">@L["Common_Date"]</th>
                                                                    <th style="width: 120px">@L["Common_Method"]</th>
                                                                    <th>@L["Common_Details"]</th>
                                                                    <th style="width: 100px">@L["Audit_AppDetails"]</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var entry in l.History.OrderByDescending(h => h.Timestamp))
                                                                {
                                                                    <tr>
                                                                        <td class="text-muted">@TZ.ToLocal(entry.Timestamp).ToString("dd/MM/yyyy HH:mm:ss")</td>
                                                                        <td><span class="badge @GetActionBadgeClass(entry.Action)">@entry.Action</span></td>
                                                                        <td class="text-info-emphasis">@entry.Details</td>
                                                                        <td class="small text-secondary">@(entry.PerformedBy == "Admin" ? L["Licenses_PerformedBy_Admin"] : entry.PerformedBy == "System" ? L["Licenses_PerformedBy_System"] : entry.PerformedBy)</td>
                                                                    </tr>
                                                                }
                                                                @if (!l.History.Any())
                                                                {
                                                                    <tr><td colspan="4" class="text-center py-3 text-muted italic">@L["Licenses_History_Empty"]</td></tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        @if (TotalCount > 0)
        {
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">@L["Common_Show"]</small>
                    <select class="form-select form-select-sm" style="width: 80px;" @bind:get="PageSize" @bind:set="ChangePageSize">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <small class="text-muted">@L["Common_Of"] @TotalCount @L["Common_Entries"]</small>
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => GoToPage(CurrentPage - 1)">@L["Common_Previous"]</button>
                        </li>
                        <li class="page-item disabled"><span class="page-link">@L["Common_Page"] @CurrentPage / @TotalPages</span></li>
                        <li class="page-item @(CurrentPage >= TotalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => GoToPage(CurrentPage + 1)">@L["Common_Next"]</button>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    }
</div>

@if (licenseToDelete != null)
{
    <div class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.6)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-danger">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger">@L["Licenses_DeleteTitle"]</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    @{
                        var softwareLabel = L["Licenses_Software"].Value.ToLower();
                    }
                    <p>@L["Common_Delete"] @softwareLabel <code>@licenseToDelete.LicenseKey</code> de <strong>@licenseToDelete.CustomerName</strong> ??</p>
                    <p class="text-warning small">@L["Licenses_DeleteWarning"]</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-outline-secondary" @onclick="CancelDelete">@L["Common_Cancel"]</button>
                    <button class="btn btn-danger" @onclick="DeleteLicense">@L["Common_Delete"]</button>
                </div>
            </div>
        </div>
    </div>
}

@if (licenseToRevoke != null)
{
    <div class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.6)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-warning">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning">@L["Licenses_Revoked"]</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelRevoke"></button>
                </div>
                <div class="modal-body">
                    <p>@string.Format(L["UI_ConfirmRevokeTitle"].Value, licenseToRevoke.CustomerName)</p>
                    <div class="mb-3">
                        <label class="small text-muted mb-1">@L["UI_RevocationReasonLabel"]</label>
                        <textarea class="form-control bg-black text-white" @bind="revocationReason" rows="2" placeholder="Ex: Remboursement, Suspicion de fraude..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-outline-secondary" @onclick="CancelRevoke">@L["Common_Cancel"]</button>
                    <button class="btn btn-warning" @onclick="RevokeLicense">@L["Licenses_Revoked"]</button>
                </div>
            </div>
        </div>
    </div>
}

@if (licenseToReset != null)
{
    <div class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.7)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-primary shadow-lg">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-primary">@L["Licenses_GlobalResetConfirmTitle"]</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => licenseToReset = null"></button>
                </div>
                <div class="modal-body">
                    <p>@string.Format(L["Licenses_GlobalResetConfirmMsg"].Value, licenseToReset.CustomerName)</p>
                    <p class="text-info small">@L["Licenses_GlobalResetNote"]</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-outline-secondary" @onclick="() => licenseToReset = null">@L["Common_Cancel"]</button>
                    <button class="btn btn-primary" @onclick="ResetAllSeats">@L["Licenses_GlobalResetBtn"]</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<License> LicensesList = new();
    private List<Product> Products = new();
    private List<LicenseType> LicenseTypes = new();
    
    private bool showCreate = false;
    private string SelectedProductId = "";
    private string SelectedTypeId = "";
    private string NewClientName = "";
    private string NewClientEmail = "";
    private int? newValidityDays = 365;
    private int newMaxSeats = 1;
    private string? GeneratedKey;

    private Guid? ExpandedLicenseId;
    private string activeDetailTab = "seats";
    
    private bool isAuthorized = false;

    // Pagination
    private int CurrentPage = 1;
    private int PageSize = 25;
    private int TotalCount = 0;
    private int TotalPages => (int)Math.Ceiling((double)TotalCount / PageSize);

    protected override async Task OnInitializedAsync()
    {
        isAuthorized = await Auth.HasPermissionAsync("licenses.view");
        if (isAuthorized)
        {
            await LoadData();
        }
    }

    private void ToggleSeats(Guid id)
    {
        if (ExpandedLicenseId == id) ExpandedLicenseId = null;
        else
        {
            ExpandedLicenseId = id;
            activeDetailTab = "seats";
        }
    }

    private async Task SwitchToHistoryTab(License l)
    {
        activeDetailTab = "history";
        // Lazy-load history on-demand
        if (!l.History.Any())
        {
            var history = await Db.LicenseHistories
                .Where(h => h.LicenseId == l.Id)
                .OrderByDescending(h => h.Timestamp)
                .ToListAsync();
            foreach (var h in history) l.History.Add(h);
        }
    }

    private string GetActionBadgeClass(string action) => action switch
    {
        HistoryActions.Created => "bg-success",
        HistoryActions.Activated => "bg-primary",
        HistoryActions.Recovery => "bg-info text-dark",
        HistoryActions.Revoked => "bg-danger",
        HistoryActions.Reactivated => "bg-success",
        HistoryActions.GlobalReset => "bg-warning text-dark",
        HistoryActions.UnlinkedApi => "bg-info",
        HistoryActions.UnlinkedManual => "bg-warning text-dark",
        HistoryActions.UnlinkedAdminTool => "bg-danger",
        _ => "bg-secondary"
    };

    private async Task ChangePageSize(int size)
    {
        PageSize = size;
        CurrentPage = 1;
        await LoadData();
    }

    private async Task GoToPage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        CurrentPage = page;
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            Products = await Db.Products.ToListAsync();
            LicenseTypes = await Db.LicenseTypes.OrderBy(t => t.Name).ToListAsync();
            
            var query = Db.Licenses.AsQueryable();
            TotalCount = await query.CountAsync();

            if (CurrentPage > TotalPages && TotalPages > 0) CurrentPage = TotalPages;
            if (CurrentPage < 1) CurrentPage = 1;

            LicensesList = await query.Include(l => l.Product)
                                      .Include(l => l.Type)
                                      .Include(l => l.Seats)
                                      .OrderByDescending(l => l.CreationDate)
                                      .Skip((CurrentPage - 1) * PageSize)
                                      .Take(PageSize)
                                      .ToListAsync();
        }
        catch (Exception ex) { Toast.ShowError($"{L["Common_Error"]} : {ex.Message}"); }
    }

    private async Task CreateLicense()
    {
        if (string.IsNullOrEmpty(SelectedProductId) || string.IsNullOrEmpty(SelectedTypeId) || string.IsNullOrEmpty(NewClientName))
        {
            Toast.ShowError(L["Licenses_MsgMissingFields"]); return;
        }

        var key = Guid.NewGuid().ToString("D").ToUpper();
        var lic = new License
        {
            ProductId = Guid.Parse(SelectedProductId),
            LicenseTypeId = Guid.Parse(SelectedTypeId),
            CustomerName = NewClientName,
            CustomerEmail = NewClientEmail,
            LicenseKey = key,
            IsActive = true,
            MaxSeats = newMaxSeats,
            ExpirationDate = (newValidityDays.HasValue && newValidityDays.Value > 0) 
                ? DateTime.UtcNow.AddDays(newValidityDays.Value) 
                : null
        };

        Db.Licenses.Add(lic);
        
        var historyMsg = L["Licenses_Action_Created"].Value
            .Replace("{0}", LicenseTypes.First(t => t.Id == lic.LicenseTypeId).Name)
            .Replace("{1}", lic.MaxSeats.ToString());

        lic.History.Add(new LicenseHistory {
            Action = HistoryActions.Created,
            Details = historyMsg,
            PerformedBy = "Admin"
        });

        await Db.SaveChangesAsync();
        GeneratedKey = key;
        
        if (!string.IsNullOrWhiteSpace(NewClientEmail))
        {
            try {
                var prod = Products.First(p => p.Id == lic.ProductId);
                await Mailer.SendLicenseEmailAsync(NewClientEmail, NewClientName, prod.Name, key);
                Toast.ShowSuccess(L["Licenses_MsgEmailSent"]);
            } catch { }
        }

        NewClientName = ""; NewClientEmail = ""; showCreate = false; newMaxSeats = 1;
        await LoadData();
    }

    private async Task Reactivate(License l) 
    { 
        l.IsActive = true; 
        l.RevocationReason = null;
        l.RevokedAt = null;

        l.History.Add(new LicenseHistory {
            Action = HistoryActions.Reactivated,
            PerformedBy = "Admin"
        });

        await Db.SaveChangesAsync(); 
        Toast.ShowSuccess(L["Licenses_MsgReactivated"]); 
        await LoadData(); 
    }
    
    private async Task DeleteSeat(LicenseSeat seat)
    {
        // On ne supprime plus, on délie (historisation)
        seat.IsActive = false;
        seat.UnlinkedAt = DateTime.UtcNow;
        
        var historyMsg = L["Licenses_Action_UnlinkedManual"].Value.Replace("{0}", seat.HardwareId);
        
        if (seat.License != null)
        {
            seat.License.History.Add(new LicenseHistory {
                Action = HistoryActions.UnlinkedManual,
                Details = historyMsg,
                PerformedBy = "Admin"
            });
        }
        else
        {
            Db.LicenseHistories.Add(new LicenseHistory {
                LicenseId = seat.LicenseId,
                Action = HistoryActions.UnlinkedManual,
                Details = historyMsg,
                PerformedBy = "Admin"
            });
        }

        await Db.SaveChangesAsync();
        Toast.ShowSuccess(L["Licenses_MsgSeatUnlinked"]);
        await LoadData();
    }

    private async Task CopyToClipboard(string text)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
        Toast.ShowInfo(L["Common_Copied"]);
    }

    private License? licenseToReset;
    private void ConfirmGlobalReset(License l)
    {
        licenseToReset = l;
    }

    private async Task ResetAllSeats()
    {
        if (licenseToReset == null) return;

        if (licenseToReset.Seats != null)
        {
            int count = 0;
            foreach (var seat in licenseToReset.Seats.Where(s => s.IsActive))
            {
                seat.IsActive = false;
                seat.UnlinkedAt = DateTime.UtcNow;
                count++;
            }
            licenseToReset.HardwareId = null; // Reset v1 compat
            licenseToReset.ActivationDate = null;
            licenseToReset.RecoveryCount = 0; // On reset le compteur d'abus lors d'un reset global manuel
            
            var historyMsg = L["Licenses_Action_GlobalReset"].Value.Replace("{0}", count.ToString());

            licenseToReset.History.Add(new LicenseHistory {
                Action = HistoryActions.GlobalReset,
                Details = historyMsg,
                PerformedBy = "Admin"
            });

            await Db.SaveChangesAsync();
            Toast.ShowSuccess(L["Licenses_MsgAllSeatsUnlinked"]);
            licenseToReset = null;
            await LoadData();
        }
    }

    private void ConfirmDelete(License l)
    {
        licenseToDelete = l;
    }

    private async Task DeleteLicense()
    {
        if (licenseToDelete == null) return;

        // On supprime vraiment les seats liés lors de la suppression de la licence parente
        if (licenseToDelete.Seats != null && licenseToDelete.Seats.Any())
        {
            Db.LicenseSeats.RemoveRange(licenseToDelete.Seats);
        }
        Db.Licenses.Remove(licenseToDelete);
        await Db.SaveChangesAsync();
        Toast.ShowSuccess(L["Licenses_MsgDeleted"]);
        licenseToDelete = null;
        await LoadData();
    }

    private void CancelDelete()
    {
        licenseToDelete = null;
    }

    private License? licenseToDelete;
    private License? licenseToRevoke;
    private string revocationReason = "";

    private void ConfirmRevoke(License l)
    {
        licenseToRevoke = l;
        revocationReason = "";
    }

    private async Task RevokeLicense()
    {
        if (licenseToRevoke == null) return;
        var lid = licenseToRevoke.Id;
        var reason = revocationReason;

        try 
        {
            // 1. Récupération d'une instance fraîche pour éviter DbUpdateConcurrencyException
            var dbLic = await Db.Licenses.Include(l => l.History).FirstOrDefaultAsync(l => l.Id == lid);
            if (dbLic == null) { Toast.ShowError(L["Resets_MsgNotFound"]); return; }

            dbLic.IsActive = false;
            dbLic.RevocationReason = reason;
            dbLic.RevokedAt = DateTime.UtcNow;

            // 2. Formatage sécurisé du message (remplace {0} par le motif)
            var historyDetail = L["Licenses_Action_Revoked"].Value.Replace("{0}", reason);

            dbLic.History.Add(new LicenseHistory {
                Action = HistoryActions.Revoked,
                Details = historyDetail,
                PerformedBy = "Admin"
            });

            await Db.SaveChangesAsync();
            
            Toast.ShowInfo(L["Licenses_MsgRevoked"]);
            licenseToRevoke = null;
            await LoadData();
        }
        catch (Exception ex)
        {
            // 3. LOG DE L'ERREUR DANS LE CYCLE DE VIE (via Factory pour être sûr que ça s'enregistre)
            try {
                using var db = await DbFactory.CreateDbContextAsync();
                db.LicenseHistories.Add(new LicenseHistory {
                    LicenseId = lid,
                    Action = "ERROR",
                    Details = $"ÉCHEC RÉVOCATION : {ex.Message} (Motif : {reason})",
                    PerformedBy = "Admin"
                });
                await db.SaveChangesAsync();
            } catch { }

            Toast.ShowError($"{L["Common_Error"]} : {ex.Message}");
            licenseToRevoke = null;
            await LoadData();
        }
    }

    private void CancelRevoke()
    {
        licenseToRevoke = null;
    }
}
