@using SoftLicence.Server.Data
@using Microsoft.EntityFrameworkCore
@inject LicenseDbContext Db
@inject SoftLicence.Server.Services.ToastService Toast
@inject IStringLocalizer<SharedResource> L

@if (User != null)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.7);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-info shadow-lg">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-info">Modifier Utilisateur : @User.Username</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Email</label>
                        <input class="form-control" type="email" @bind="User.Email" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">@L["Common_Type"]</label>
                        <select class="form-select" @bind="User.RoleId">
                            @foreach (var role in Roles)
                            {
                                <option value="@role.Id">@role.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">@L["Users_AdminPath"] (@L["Common_Select"])</label>
                        <div class="input-group">
                            <span class="input-group-text bg-black border-secondary text-muted">/</span>
                            <input class="form-control bg-black text-info" @bind="User.AdminPath" placeholder="@L["Users_AdminPathPlaceholder"]" />
                        </div>
                        <small class="text-muted" style="font-size: 0.7rem;">@L["Users_AdminPathDescription"]</small>
                    </div>
                    <div class="form-check form-switch mt-4">
                        <input class="form-check-input" type="checkbox" id="edit_enabled" @bind="User.IsEnabled">
                        <label class="form-check-label @(User.IsEnabled ? "text-success" : "text-danger")" for="edit_enabled">
                            @(User.IsEnabled ? "Compte Activé" : "Compte Désactivé")
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-secondary" @onclick="Close">@L["Common_Cancel"]</button>
                    <button class="btn btn-success" @onclick="Save">@L["Common_Save"]</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public AdminUser? User { get; set; }
    [Parameter] public List<AdminRole> Roles { get; set; } = new();
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }

    private async Task Close() => await OnClose.InvokeAsync();

    private async Task Save()
    {
        if (User == null) return;
        
        if (string.IsNullOrWhiteSpace(User.Email))
        {
            Toast.ShowError("Email requis."); return;
        }

        // Nettoyage et validation de l'AdminPath
        if (!string.IsNullOrWhiteSpace(User.AdminPath))
        {
            User.AdminPath = User.AdminPath.Trim().Trim('/').ToLower();

            // 1. Caractères autorisés (a-z, 0-9, -)
            if (!System.Text.RegularExpressions.Regex.IsMatch(User.AdminPath, "^[a-z0-9-]+$"))
            {
                Toast.ShowError("L'URL ne doit contenir que des lettres, chiffres et tirets.");
                return;
            }

            // 2. Interdiction du mot "admin"
            if (User.AdminPath.Contains("admin"))
            {
                Toast.ShowError("Sécurité : Le mot 'admin' est interdit dans l'URL personnalisée.");
                return;
            }
        }
        else
        {
            User.AdminPath = null;
        }

        await OnSave.InvokeAsync();
    }
}
