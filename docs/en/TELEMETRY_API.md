# SoftLicence Telemetry API

This documentation describes the telemetry API specifications built into the SoftLicence server.

## 1. General Information

* **Data format**: JSON
* **HTTP method**: `POST`
* **Content-Type**: `application/json`
* **Authentication**: Based on `HardwareId` (included in every request).

## 2. Common Structure (Header)

Every request sent by the application contains the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `Timestamp` | DateTime (UTC) | Date and time of the event. |
| `HardwareId` | String | Unique PC identifier (generated by SoftLicence). |
| `AppName` | String | Application name (e.g., "YourApp"). |
| `Version` | String | Application version (e.g., "1.0.4"). |
| `EventName` | String | Event name (e.g., "AppStarted", "Error"). |

---

## 3. Specific Endpoints

### 3.1. Simple Events
**URL**: `/api/telemetry/event`

Used for lifecycle tracking and usage monitoring.

**Payload:**
```json
{
  "Timestamp": "2026-02-10T23:45:00Z",
  "HardwareId": "XXXX-XXXX-XXXX-XXXX",
  "AppName": "YourApp",
  "Version": "1.0.4",
  "EventName": "PluginsLoaded",
  "Properties": {
    "Count": "2",
    "PluginIds": "MyApp.Plugin.HelloWorld,MyApp.Plugin.Recordings"
  }
}
```

**Events sent by the app:**
* `AppStarted`: On successful host launch.
* `PluginsLoaded`: After scanning plugin directories.
* `LicenseActivated`: After a successful activation (contains the key in `Properties`).

---

### 3.2. Diagnostic Reports
**URL**: `/api/telemetry/diagnostic`

Sent on each network diagnostic execution (Pre-flight).

**Payload:**
```json
{
  "Timestamp": "2026-02-10T23:45:00Z",
  "HardwareId": "XXXX-XXXX-XXXX-XXXX",
  "Version": "1.0.4",
  "EventName": "DiagnosticResult",
  "Score": 85,
  "Results": [
    {
      "ModuleName": "Windows Firewall",
      "Success": true,
      "Severity": "Info",
      "Message": "YourApp is allowed."
    },
    {
      "ModuleName": "SIP ALG",
      "Success": false,
      "Severity": "Error",
      "Message": "SIP ALG detected on the router."
    }
  ],
  "Ports": [
    { "Name": "SIP Signaling", "ExternalPort": 15060, "Protocol": "UDP" },
    { "Name": "RTP Audio", "ExternalPort": 10000, "Protocol": "UDP" }
  ]
}
```

---

### 3.3. Errors and Crashes
**URL**: `/api/telemetry/error`

Captures unhandled exceptions and critical failures.

**Payload:**
```json
{
  "Timestamp": "2026-02-10T23:45:00Z",
  "HardwareId": "XXXX-XXXX-XXXX-XXXX",
  "Version": "1.0.4",
  "EventName": "Error",
  "ErrorType": "FatalUnhandled",
  "Message": "Object reference not set to an instance of an object.",
  "StackTrace": "at YourApp.UI.App.OnStartup..."
}
```

**Error types sent:**
* `FatalUnhandled`: Global application crash.
* `UiCrash`: Error in the WPF rendering loop.
* `NetworkError`: Network-related failure.
* `LicenseNetworkError`: Unable to reach the license server.

---

## 4. Automatic Activation (Trial)

**URL**: `/api/activation/trial`

Used on the first application launch if no license is present locally.

**Payload:**
```json
{
  "HardwareId": "XXXX-XXXX-XXXX-XXXX",
  "AppName": "YourApp",
  "TypeSlug": "TRIAL"
}
```

**Response (Success 200):**
```json
{
  "LicenseFile": "BASE64_SIGNED_DATA..."
}
```

---

## 5. Server Recommendations

1. **Deduplication**: Use the `HardwareId` to avoid counting the same user multiple times in your daily statistics.
2. **Alerts**: Set up an alert (email or Discord/Slack) if the `/error` endpoint receives more than X messages in one hour (indicates a widespread bug).
3. **Storage**: A NoSQL database (MongoDB) or a simple SQL table with a JSON field is recommended for storing diagnostic `Results` which are variable.
4. **Response**: The server should respond quickly (HTTP 200 or 202) to not slow down the client, even if it processes data asynchronously.
